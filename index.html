<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telegram WebApp — Rewarded Ad Demo</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;background:#f5f7fb}
    .card{width:min(720px,96%);background:white;border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(20,30,60,0.08)}
    h1{margin:0 0 8px;font-size:20px}
    p{color:#475569;margin:6px 0}
    .balance{font-weight:700;font-size:28px;margin:12px 0}
    .btn{display:inline-block;padding:10px 16px;border-radius:10px;border:0;background:#2563eb;color:white;font-weight:600;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:default}
    .note{font-size:13px;color:#6b7280;margin-top:8px}
    .log{background:#0f172a;color:white;padding:10px;border-radius:8px;margin-top:12px;white-space:pre-wrap;font-family:monospace;font-size:13px;max-height:160px;overflow:auto}
    .ad-frame{border-radius:8px;background:#111827;color:white;padding:18px;text-align:center;margin-top:12px}
    .ad-timer{font-size:24px;font-weight:700}
  </style>
</head>
<body>
  <div class="card" role="main">
    <h1>Rewarded Ad — демо для Telegram WebApp</h1>
    <p>Эта страница демонстрирует поток: открыть WebApp из Telegram → посмотреть рекламный ролик → сервер получает подтверждение и начисляет внутриигровую валюту.</p>

    <div>
      <div>Пользователь:</div>
      <div id="userInfo">Не инициализирован</div>
    </div>

    <div class="balance" id="balance">Баланс: —</div>

    <div>
      <button id="watchBtn" class="btn">Посмотреть рекламу — получить 50 Coin</button>
      <button id="closeBtn" class="btn" style="background:#ef4444;margin-left:8px">Закрыть WebApp</button>
      <div class="note">Тестовая версия: здесь показан placeholder ролика. Для продакшна замените логику на SDK вашей рекламной сети и валидацию на сервере.</div>
    </div>

    <div id="adContainer"></div>

    <div class="log" id="log">Логи:

</div>
  </div>

<script>
// =============================
// Конфигурация
// =============================
const BACKEND_VERIFY_URL = 'https://your-backend.example.com/api/ad_complete'; // <- замените на ваш сервер
const REWARD_AMOUNT = 50; // сколько монет давать за просмотр
const COOLDOWN_SECONDS = 30; // локальный cooldown (доп. защита от мульти-кликов)

// =============================
// Телеграм WebApp init
// =============================
// В WebApp Telegram автоматически вставляет объект window.Telegram.WebApp
// Однако в режиме превью в браузере этого объекта нет — код поддерживает fallback для локальной отладки.

const logEl = document.getElementById('log');
function log(...args){
  const line = '[' + new Date().toLocaleTimeString() + '] ' + args.join(' ');
  logEl.textContent += '\n' + line;
  logEl.scrollTop = logEl.scrollHeight;
  console.log(...args);
}

let tg = window.Telegram ? window.Telegram.WebApp : null;
let initData = null;
let user = null;
let balance = 0;

function initWebApp(){
  if(tg){
    // Официальный WebApp
    initData = tg.initData || null;
    try{ user = tg.initDataUnsafe ? tg.initDataUnsafe.user : null; } catch(e){ user = null }
    if(user) document.getElementById('userInfo').textContent = `${user.first_name || ''} ${user.last_name || ''} (@${user.username || '-'}) — id:${user.id}`;
    else document.getElementById('userInfo').textContent = 'Невозможно получить user (в режиме превью используйте локальный мок)';
    tg.expand();
    log('Инициализация WebApp через Telegram.', JSON.stringify(tg.initDataUnsafe || {}));
  } else {
    // Fallback — локальная отладка
    user = { id: 123456789, first_name: 'Тест', username: 'testuser' };
    initData = 'local_preview_initdata';
    document.getElementById('userInfo').textContent = `${user.first_name} (@${user.username}) — id:${user.id} (локальный режим)`;
    log('Запущено в локальном режиме (preview) — Telegram WebApp объект не найден.');
  }
  // Запросим баланс у сервера (или подставим локальный для демо)
  fetchBalanceFromServer();
}

// =============================
// Баланс
// =============================
async function fetchBalanceFromServer(){
  try{
    // Для безопасности в продакшне отправляйте initData на backend, чтобы он проверил подпись Telegram
    // Здесь — демонстрация: попытка получить баланс с бэка
    const resp = await fetch('/api/get_balance', { // <- замените endpoint
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ telegram_id: user ? user.id : null, initData })
    });
    if(resp.ok){
      const data = await resp.json();
      balance = data.balance || 0;
      updateBalanceUI();
      log('Баланс получен от сервера:', balance);
    } else {
      log('Баланс: ответ сервера не OK (использую локальный).', resp.status);
      balance = 0;
      updateBalanceUI();
    }
  }catch(e){
    log('Ошибка при получении баланса (использую локальный):', e.message);
    balance = 0;
    updateBalanceUI();
  }
}

function updateBalanceUI(){
  document.getElementById('balance').textContent = `Баланс: ${balance} Coin`;
}

// =============================
// Просмотр рекламы (демо)
// =============================
let cooldownUntil = 0;
const watchBtn = document.getElementById('watchBtn');
const closeBtn = document.getElementById('closeBtn');
const adContainer = document.getElementById('adContainer');

watchBtn.addEventListener('click', onWatchClicked);
closeBtn.addEventListener('click', () => { if(tg) tg.close(); else log('Закрытие WebApp: симуляция.');});

async function onWatchClicked(){
  const now = Date.now()/1000;
  if(now < cooldownUntil){
    const wait = Math.ceil(cooldownUntil - now);
    log(`Нельзя смотреть рекламу ещё ${wait}s — локальный cooldown.`);
    return;
  }
  watchBtn.disabled = true;
  try{
    // Откроем placeholder "рекламы" — в реальной конструкции здесь будет SDK провайдера
    await playPlaceholderAd();
    // После успешного просмотра — отправляем подтверждение на сервер
    await sendAdCompleteToServer({ provider: 'demo', ad_id: 'demo_ad_001', watched_seconds: 15, reward: REWARD_AMOUNT });
  }catch(e){
    log('Ошибка при показе рекламы или верификации:', e.message || e);
  } finally{
    cooldownUntil = Date.now()/1000 + COOLDOWN_SECONDS;
    setTimeout(()=>{ watchBtn.disabled = false; }, COOLDOWN_SECONDS*1000);
  }
}

function playPlaceholderAd(){
  return new Promise((resolve, reject)=>{
    adContainer.innerHTML = '';
    const ad = document.createElement('div');
    ad.className = 'ad-frame';
    ad.innerHTML = `<div style="opacity:.8">Рекламный ролик (демо)</div><div style="height:10px"></div><div class="ad-timer" id="adTimer">15</div><div style="height:10px"></div><div style="font-size:13px;opacity:.9">Нажмите "Пропустить" после 5s</div><div style="height:10px"></div>`;
    const skipBtn = document.createElement('button');
    skipBtn.textContent = 'Пропустить';
    skipBtn.className = 'btn';
    skipBtn.style.background = '#10b981';
    skipBtn.disabled = true;
    ad.appendChild(skipBtn);
    adContainer.appendChild(ad);

    let t = 15; // длительность в сек
    const timer = setInterval(()=>{
      t -= 1;
      const el = document.getElementById('adTimer');
      if(el) el.textContent = t;
      if(t <= 10) skipBtn.disabled = false; // можно пропустить после 5s (в демо — после 10s)
      if(t <= 0){
        clearInterval(timer);
        adContainer.innerHTML = '';
        log('Ролик досмотрен полностью.');
        resolve();
      }
    }, 1000);

    skipBtn.addEventListener('click', ()=>{
      clearInterval(timer);
      adContainer.innerHTML = '';
      log('Ролик был пропущен пользователем — в демо это считается просмотром.');
      resolve();
    });
  });
}

// =============================
// Отправка подтверждения на сервер
// =============================
async function sendAdCompleteToServer(adEvent){
  log('Отправляю подтверждение на сервер...', JSON.stringify(adEvent));
  try{
    // В prod: отправляйте вместе с подписанным initData (Telegram WebApp initData) и/или подпиской от провайдера рекламы.
    const payload = {
      telegram_id: user ? user.id : null,
      initData: initData,
      ad: adEvent,
      client_ts: new Date().toISOString()
    };
    const resp = await fetch(BACKEND_VERIFY_URL, {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    if(!resp.ok){
      const t = await resp.text();
      log('Сервер вернул ошибку:', resp.status, t);
      throw new Error('Server error: ' + resp.status);
    }
    const data = await resp.json();
    if(data.success){
      balance = (data.new_balance !== undefined) ? data.new_balance : balance + adEvent.reward;
      updateBalanceUI();
      log(`Начислено ${adEvent.reward} Coin. Новый баланс: ${balance}`);
      // Уведомим родительский бот через Telegram API (опционально) — например, через серверный push
    } else {
      log('Сервер не подтвердил начисление: ' + JSON.stringify(data));
      throw new Error('Verification failed');
    }
  }catch(e){
    log('Ошибка отправки подтверждения на сервер:', e.message || e);
    alert('Не удалось подтвердить просмотр у сервера. Повторите позже.');
  }
}

// =============================
// Запуск
// =============================
initWebApp();

</script>
</body>
</html>
